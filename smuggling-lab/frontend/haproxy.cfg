global
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option http-server-close
    option forwardfor

frontend fe_http
    bind *:80

    # ── TE.CL Defense ────────────────────────────────────────────────────────
    #
    # In TE.CL smuggling the attacker sends:
    #   Transfer-Encoding: chunked   ← HAProxy reads the full chunked body
    #   Content-Length: 4            ← Flask reads only 4 bytes
    #
    # The primary defense is to normalize ALL requests before forwarding:
    # strip Transfer-Encoding and rewrite the body as Content-Length only.
    # This removes the ambiguity entirely — the backend never sees TE: chunked.
    #
    # NOTE: HAProxy 2.4 strips Content-Length when Transfer-Encoding is
    # present before ACL evaluation (same limitation as in haproxy_secure.cfg).
    # Therefore the ACL below catches TE-only requests as defense-in-depth,
    # but the real enforcement is at the Flask backend layer (app_secure.py).
    # ─────────────────────────────────────────────────────────────────────────

    # Block any request that carries Transfer-Encoding: chunked
    # (TE.CL attack always requires TE on the outer request)
    acl has_te       req.hdr_cnt(transfer-encoding) gt 0
    acl has_cl       req.hdr_cnt(content-length) gt 0

    # Block TE-only requests (pure TE.CL vector)
    http-request deny deny_status 400 if has_te !has_cl

    # Block requests with both headers (covers CL.TE and TE.CL simultaneously)
    http-request deny deny_status 400 if has_cl has_te

    # Strip Transfer-Encoding before forwarding to prevent desync
    # even if the ACL above does not fire (HAProxy normalization quirk)
    http-request del-header Transfer-Encoding

    default_backend be_cache

backend be_cache
    # http-server-close ensures HAProxy does NOT reuse backend TCP connections.
    # Reused connections are what allow smuggled bytes to persist in the buffer
    # and be prepended to the next request — closing them after each response
    # eliminates the TE.CL attack surface entirely.
    option http-server-close
    server cache cache:6081 check
