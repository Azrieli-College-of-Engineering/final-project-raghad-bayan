global
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    # VULNERABLE: http-server-close is intentionally REMOVED here.
    # With http-server-close, HAProxy closes the backend TCP connection
    # after every response, which prevents smuggled bytes from persisting
    # in the buffer and being prepended to the next request.
    # Removing it allows backend connection reuse — enabling cache poisoning.
    option forwardfor

frontend fe_http
    bind *:80

    # NOTE: No CL+TE ACL here — we want smuggling to reach the backend
    # so the cache poisoning demo works end-to-end.

    # Forward X-Forwarded-Host for host header injection demo
    http-request set-header X-Forwarded-Host %[req.hdr(X-Forwarded-Host)] if { req.hdr(X-Forwarded-Host) -m found }

    default_backend be_cache

backend be_cache
    # VULNERABLE: no http-server-close — backend connections are reused.
    # This is what allows the smuggled GET /api/user to be processed
    # when the next victim request arrives on the reused connection.
    server cache cache:6081 check