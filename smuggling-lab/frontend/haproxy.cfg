global
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option http-server-close
    option forwardfor

frontend fe_http
    bind *:80

    # NOTE: HAProxy 2.4 strips Content-Length when Transfer-Encoding is
    # present before ACL evaluation, so this ACL is defense-in-depth only.
    # The real enforcement is at the Flask backend layer (app.py).
    acl has_cl req.hdr_cnt(content-length) gt 0
    acl has_te req.hdr_cnt(transfer-encoding) gt 0
    http-request deny deny_status 400 if has_cl has_te

    # ── Host Header Injection vulnerability ───────────────────────────────────
    # VULNERABLE: X-Forwarded-Host is forwarded as-is to the backend.
    # Flask trusts this header to build absolute URLs (e.g. reset links).
    # An attacker can inject X-Forwarded-Host: evil.attacker.com and the
    # backend will generate a reset link pointing to the attacker's domain.
    #
    # A secure config would do:
    #   http-request del-header X-Forwarded-Host
    # but we intentionally forward it here to demonstrate the attack.
    # ─────────────────────────────────────────────────────────────────────────
    http-request set-header X-Forwarded-Host %[req.hdr(X-Forwarded-Host)] if { req.hdr(X-Forwarded-Host) -m found }

    default_backend be_cache

backend be_cache
    option http-server-close
    server cache cache:6081 check