global
    log stdout format raw local0

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    option http-server-close
    option forwardfor

frontend fe_http
    bind *:80
    
    # NOTE: HAProxy 2.4 strips Content-Length when Transfer-Encoding is
    # present before ACL evaluation, so the CL+TE ACL below is kept as
    # defense-in-depth but the primary defense is at the Flask backend layer.
    # The real fix is HTTP/2 end-to-end which eliminates this ambiguity entirely.
    # Block requests with both Content-Length AND Transfer-Encoding (smuggling prevention)
    acl has_cl req.hdr_cnt(content-length) gt 0
    acl has_te req.hdr_cnt(transfer-encoding) gt 0
    http-request deny deny_status 400 if has_cl has_te
    
    default_backend be_cache

backend be_cache
    option http-server-close
    server cache cache:6081 check
